---
title: "2. DX 基础环境部署"
chapter: false
weight: 12
tags:
  - Direct Connect
---

{{% notice info %}}
本章节的 DX 基础环境是后续所有实验的基础，必须先完成本章节基础环境配置，才能开始后面章节的实验。 
{{% /notice  %}}

**本章节实验拓扑如下，将会使用第一个 VIF，VLAN ID 为 10xx。**
 - 使用 CloudFormation 模版，部署 VPC，Bastion host 和 VGW
 - 将第一个 DX Virtual Interface 关联到 VGW
 - 登录到 bastion host，验证 DX 连通性
![](/images/DX/DXBasic-topology.png)


## 部署 DX 基础实验环境

点击下面 Launch Stack， 使用 CloudFormation 部署 DX 基础环境。

**[Launch Stack](https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/new?stackName=dxlab-bastion&templateURL=http://dx-hands-on.araki.in/_static/dxlab-bastion.template)**

 - 堆栈名称： ```dxlab-bastion```
 - 选择 KeyPair 作为登录 bastion host 的 SSH Key，如果没有Key Pair，需要提前创建一个

![](/images/DX/DXBasic-1.png)

CloudFormation将创建以下主要资源：
- VPC及相关资源： 10.7.0.0/16
- Bastion EC2
- VGW，并已 Attach 到 VPC

## 配置 DX VIF 连接

在 CloudFormation 部署完成后，需要接受 VLAN ID 为 10xx 的 dxvif，然后 attach 到 CloudFormation 创建的 VGW 上。

{{% notice info %}}
以下步骤均通过 AWS 控制台中的 CloudShell 操作为例。
当然您也可以自行在各个服务的控制台中操作。
{{% /notice  %}}

1. 在 CloudShell 中粘贴并运行以下命令，获取 CloudFormation 创建的 VGW ID
```
DX_CF_STACK_NAME='dxlab-bastion'
DX_VGWID_10xx=`aws cloudformation describe-stack-resources \
--stack-name ${DX_CF_STACK_NAME} | \
jq -r --arg stackname ${DX_CF_STACK_NAME} '.StackResources[] | \
select(.ResourceType == "AWS::EC2::VPNGateway") | .PhysicalResourceId' ` && \
echo ${DX_VGWID_10xx}

```
运行后，输出示例如下：
```
vgw-0270f9695b0640212
```

2. 获取 VLAN ID 为 10xx 的 DX VIF。
```
DX_VIFID_10xx=`aws directconnect describe-virtual-interfaces \
| jq -r '.virtualInterfaces[] |  select(.vlan < 1100) |select(.vlan >= 1000) | .virtualInterfaceId' ` && echo ${DX_VIFID_10xx}

```
运行后，输出示例如下：
```
dxvif-ffiog0vr
```

3. 接受 DX Virtual Interface，并关联到 VGW 上。
```
aws directconnect confirm-private-virtual-interface \
--virtual-interface-id ${DX_VIFID_10xx} \
--virtual-gateway-id ${DX_VGWID_10xx}

```
运行后，输出示例如下：
```
{
 "virtualInterfaceState": "pending"
}
```
等待Virtual Interface 的状态将从 pending 到 down，最终变为 available。
